# Parent function: tpa:teleport/next_node(teleport_state==0)

data modify storage tpa:tpa temp.teleport.next_node set value []
function tpa:teleport/anchor/calc_node
execute if score #dir tpa.variables matches 0 run function tpa:teleport/anchor/last_approach
execute if score #dir tpa.variables matches 1 run function tpa:teleport/anchor/approach/east
execute if score #dir tpa.variables matches 2 run function tpa:teleport/anchor/approach/south_east
execute if score #dir tpa.variables matches 3 run function tpa:teleport/anchor/approach/south
execute if score #dir tpa.variables matches 4 run function tpa:teleport/anchor/approach/south_west
execute if score #dir tpa.variables matches 5 run function tpa:teleport/anchor/approach/west
execute if score #dir tpa.variables matches 6 run function tpa:teleport/anchor/approach/north_west
execute if score #dir tpa.variables matches 7 run function tpa:teleport/anchor/approach/north
execute if score #dir tpa.variables matches 8 run function tpa:teleport/anchor/approach/north_east
execute store result storage tpa:tpa temp.teleport.next_node_x double 1 run scoreboard players get #x tpa.variables
execute store result storage tpa:tpa temp.teleport.next_node_z double 1 run scoreboard players get #z tpa.variables
data modify storage tpa:tpa temp.teleport.next_node append from storage tpa:tpa temp.teleport.next_node_x
data modify storage tpa:tpa temp.teleport.next_node append value 336.0d
data modify storage tpa:tpa temp.teleport.next_node append from storage tpa:tpa temp.teleport.next_node_z

execute if score #dir tpa.variables matches 1..8 run kill @e[tag=tpa.teleport_anchor, limit=1, sort=nearest]
execute if score #dir tpa.variables matches 1..8 run function tpa:teleport/summon_anchor
data modify entity @e[sort=nearest, limit=1, tag=tpa.teleport_anchor] Pos set from storage tpa:tpa temp.teleport.next_node
tp @p[tag=tpa.teleport] @e[sort=nearest, limit=1, tag=tpa.teleport_anchor]

scoreboard players operation #d tpa.variables = #max_d tpa.variables
scoreboard players operation #d tpa.variables -= #dx tpa.variables
scoreboard players operation #d tpa.variables -= #dz tpa.variables

# Debugs
execute if score #debug_mode tpa.config matches 1 run tellraw @a ["[§bTPA§r] §6 Debug§r: Anchor Teleport approached once: ", {"score":{"objective":"tpa.variables","name":"#d"}, "color": "green"}, "/",{"score":{"objective":"tpa.variables","name":"#max_d"}}]
scoreboard players operation #current tpa.variables = #d tpa.variables
scoreboard players operation #total tpa.variables = #max_d tpa.variables
function tpa:teleport/progress_bar/main
function tpa:load_lang
title @s actionbar [{"storage": "tpa:tpa", "nbt": "loaded_lang.teleport_anchor_actionbar"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[0]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[1]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[2]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[3]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[4]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[5]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[6]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[7]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[8]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[9]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[10]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[11]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[12]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[13]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[14]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[15]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[16]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[17]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[18]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[19]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[20]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[21]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[22]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[23]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[24]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[25]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[26]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[27]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[28]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[29]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[30]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[31]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[32]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[33]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[34]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[35]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[36]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[37]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[38]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[39]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[40]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[41]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[42]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[43]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[44]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[45]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[46]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[47]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[48]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[49]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[50]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[51]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[52]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[53]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[54]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[55]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[56]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[57]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[58]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[59]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[60]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[61]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[62]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[63]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[64]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[65]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[66]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[67]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[68]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[69]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[70]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[71]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[72]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[73]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[74]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[75]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[76]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[77]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[78]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[79]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[80]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[81]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[82]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[83]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[84]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[85]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[86]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[87]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[88]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[89]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[90]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[91]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[92]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[93]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[94]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[95]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[96]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[97]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[98]"}, {"storage": "tpa:tpa", "nbt": "temp.progress_bar[99]"}, "§r  (", {"score": {"name": "#percentage", "objective": "tpa.variables"}},"%)"]
